<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bảng tra cứu chỉ số cây trồng 🌿</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #eaf7e5;
      color: #333;
    }
    .container {
      max-width: 850px;
      margin: 40px auto;
      background: #fff;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 0 12px #b7d3b1;
    }
    h1 {
      text-align: center;
      color: #2e7d32;
    }
    .search-bar {
      text-align: center;
      margin-bottom: 20px;
    }
    select, input {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 0 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #c8e6c9;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #a5d6a7;
    }
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.25s;
    }
    .btn-success {
      background: #4caf50;
      color: white;
    }
    .btn-success:hover {
      background: #43a047;
    }
    #note {
      text-align: center;
      font-style: italic;
      color: #555;
    }
    .plant-header {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🌾 BẢNG TRA CỨU CHỈ SỐ CÂY TRỒNG</h1>

    <div class="search-bar">
      <label>🔍 Tìm cây:</label>
      <input type="text" id="searchInput" placeholder="Gõ tên cây (ví dụ: ớt, lan, xà lách)">
      <span>Hoặc chọn cây:</span>
      <select id="plantSelect"></select>
    </div>

    <div class="plant-info" id="plantInfo">
      <div class="plant-header">
        <div id="plantIcon" style="font-size:48px;">🌱</div>
        <h2 id="plantName">Tên cây</h2>
        <p id="plantLatin"><em>(Tên khoa học)</em></p>
      </div>

      <table>
        <thead>
          <tr>
            <th>Thông số</th>
            <th>Giá trị phù hợp</th>
          </tr>
        </thead>
        <tbody id="paramTable"></tbody>
      </table>

      <p id="note"><em>Chọn cây để xem thông số khuyến nghị.</em></p>

      <div style="text-align:center; margin-top:20px;">
        <button id="applyBtn" class="btn btn-success">🌿 Áp dụng thông số</button>
      </div>
    </div>
  </div>

  <script>
    // 🌱 Danh sách cây trồng
    const plants = [
      {
        name: "Lúa",
        latin: "Oryza sativa",
        icon: "🌾",
        as: "Ánh sáng đầy đủ ~12 giờ/ngày, 10000–30000 lux",
        nd: "20–35°C",
        da: "80–90%",
        ph: "5.5–7.0",
        tuoi: "Thường xuyên giữ ẩm",
        note: "Ưa nước, thích hợp đất phù sa."
      },
      {
        name: "Cà chua",
        latin: "Solanum lycopersicum",
        icon: "🍅",
        as: "6~8 giờ sáng/ngày, 10000–20000 lux",
        nd: "22–28°C",
        da: "60–70%",
        ph: "6.0–6.8",
        tuoi: "Vừa phải, tránh úng",
        note: "Cần nhiều ánh sáng và thoáng khí."
      },
      {
        name: "Xà lách",
        latin: "Lactuca sativa",
        icon: "🥬",
        as: "4~6 giờ/ngày, 6000–8000 lux",
        nd: "15–25°C",
        da: "60–70%",
        ph: "6.0–6.8",
        tuoi: "Giữ ẩm thường xuyên, tránh khô hạn",
        note: "Phát triển tốt ở khí hậu mát."
      },
      {
        name: "Ớt",
        latin: "Capsicum annuum",
        icon: "🌶️",
        as: "Nắng 6~8 giờ/ngày, 6000–12000 lux",
        nd: "25–30°C",
        da: "60–70%",
        ph: "6.0–7.0",
        tuoi: "Đều đặn, tránh úng",
        note: "Ưa sáng, cần đất thoát nước tốt."
      },
      {
        name: "Dưa leo",
        latin: "Cucumis sativus",
        icon: "🥒",
        as: "Nắng nhẹ đến trung bình, 6000–12000 lux",
        nd: "20–30°C",
        da: "70–80%",
        ph: "5.5–7.0",
        tuoi: "Giữ ẩm đất liên tục",
        note: "Cần nhiều nước và giá thể thoáng."
      },
      {
        name: "Hoa Hồng",
        latin: "Rosa spp.",
        icon: "🌹",
        as: "Ánh sáng mạnh 6~8h/ngày, 10000–13500 lux",
        nd: "25–32°C",
        da: "50–70%",
        ph: "6.0–6.8",
        tuoi: "2–3 lần/tuần",
        note: "Ưa nắng, đất tơi xốp."
      },
      {
        name: "Cây không khí",
        latin: "Tillandsia spp.",
        icon: "🌿",
        as: "Ánh sáng tán xạ không nắng gắt, 1500–3000 lux",
        nd: "20–30°C",
        da: "50–70%",
        ph: "Không áp dụng (không đất)",
        tuoi: "Phun sương 1–2 lần/ngày",
        note: "Không cần đất, chỉ cần độ ẩm và lưu thông khí."
      },
      {
        name: "Phong lan Dendrobium",
        latin: "Dendrobium spp.",
        icon: "🌸",
        as: "Ánh sáng gián tiếp, 10700–16000 lux",
        nd: "20–30°C",
        da: "60–80%",
        ph: "5.5–6.5",
        tuoi: "2–3 lần/tuần",
        note: "Ưa ẩm, tránh nắng gắt."
      },
      {
        name: "Phong lan Hồ Điệp",
        latin: "Phalaenopsis spp.",
        icon: "💮",
        as: "Gián tiếp, 5400–7290 lux",
        nd: "18–28°C",
        da: "60–80%",
        ph: "5.5–6.5",
        tuoi: "2–3 lần/tuần, phun sương nhẹ",
        note: "Ưa ẩm, không chịu nắng trực tiếp."
      },
      {
        name: "Dương xỉ tổ chim",
        latin: "Asplenium nidus",
        icon: "🌱",
        as: "Ánh sáng tán xạ, tránh nắng gắt",
        nd: "18–28°C",
        da: "60–80%",
        ph: "5.0–6.5",
        tuoi: "Giữ ẩm đất, tránh úng",
        note: "Ưa mát, trồng nơi có độ ẩm cao."
      },
      {
        name: "Phong lan Cattleya",
        latin: "Cattleya spp.",
        icon: "🌼",
        as: "Ánh sáng gián tiếp, 16200–27000 lux",
        nd: "20–32°C",
        da: "60–80%",
        ph: "5.5–6.5",
        tuoi: "2 lần/tuần, phun sương khi khô",
        note: "Ưa sáng nhẹ, cần thông thoáng khí."
      }
    ];

    const select = document.getElementById("plantSelect");
    const tableBody = document.getElementById("paramTable");
    const searchInput = document.getElementById("searchInput");

    
  // Helper function to normalize text by removing accents and converting to lowercase
  function normalizeText(text) {
    return text
      .toLowerCase()                               // Convert to lowercase
      .normalize("NFD")                             // Decompose characters with accents
      .replace(/[\u0300-\u036f]/g, "")              // Remove diacritics (accents)
      .replace(/\s+/g, "");                         // Remove spaces
  }

  // Function to filter plants based on the normalized search input
  function filterPlants(keyword) {
    const normalizedKeyword = normalizeText(keyword);

    // If the search term is empty or less than 2 characters, return all plants
    if (normalizedKeyword.length < 2) {
      loadPlantList(plants); // Show all plants if the search term is empty or too short
      return;
    }

    const filteredPlants = plants.filter(plant => 
      normalizeText(plant.name).includes(normalizedKeyword)  // Match the whole search string
    );

    // Load the filtered plants into the dropdown
    loadPlantList(filteredPlants); 
  }

  // Event listener for the search input field
  searchInput.addEventListener("input", e => {
    const keyword = e.target.value.trim();
    filterPlants(keyword); // Filter based on user input
  });

  // Function to display plants in the select dropdown
  function loadPlantList(list) {
    select.innerHTML = ""; // Clear the previous options

    // If no plants match, show a message in the dropdown
    if (list.length === 0) {
      const blankOption = document.createElement("option");
      blankOption.value = "";
      blankOption.textContent = "Không tìm thấy cây...";  // "No plants found"
      select.appendChild(blankOption);
    } else {
      // Populate the dropdown with filtered plants
      list.forEach((p, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${p.icon} ${p.name}`;  // Showing both icon and name
        select.appendChild(opt);
      });
    }
  }

  // Hiển thị thông tin cây (Show plant information)
  function showPlant(i) {
    if (i === "" || i === undefined) return;  // If no plant is selected, do nothing

    const p = plants[i];
    document.getElementById("plantIcon").textContent = p.icon;
    document.getElementById("plantName").textContent = p.name;
    document.getElementById("plantLatin").innerHTML = `<em>${p.latin}</em>`;
    tableBody.innerHTML = ` 
      <tr><td>Ánh sáng</td><td>${p.as}</td></tr>
      <tr><td>Nhiệt độ</td><td>${p.nd}</td></tr>
      <tr><td>Độ ẩm đất</td><td>${p.da}</td></tr>
      <tr><td>pH</td><td>${p.ph}</td></tr>
      <tr><td>Tưới</td><td>${p.tuoi}</td></tr>
    `;
    document.getElementById("note").textContent = p.note;
  }

  // Set up an event listener for when a user selects a plant from the dropdown
  select.addEventListener("change", e => {
    showPlant(e.target.value);  // Display selected plant's info
  });

  // Initialize with all plants (optional, but if you want it to show the full list initially)
  loadPlantList(plants);

  // Show info for the first plant by default (in case of initial page load)
  showPlant(0);

    

    // 🌿 Nút áp dụng thông số — gửi sang ESP32 / IoT
  const BLYNK_API_URL = "https://cloud.blynk.cc/api/v1"; // Blynk Cloud API URL
  const BLYNK_AUTH_TOKEN = "QhaE1GqAW43iph5gu06laqEN7EcyEpFv"; // Your Blynk project Auth Token

  // Virtual pins on Blynk (v1, v2, v3, etc.)
  const VIRTUAL_PINS = {
    3: 'tempmin',    
    4: 'tempmax',        
    8: 'hummin',     
    9: 'hummax', 
    12: 'lightmin',   
    13: 'lightmax',  
  };

  // Handling the button click
  document.getElementById("applyBtn").addEventListener("click", async () => {
    const i = select.value; // Get selected plant index
    const data = plants[i];  // Get plant data

    try {
      // Send all data to Blynk at once
      await sendMultipleDataToBlynk(data);
      alert(`🌿 Đã gửi thông số "${data.name}" đến Blynk!`);
    } catch (err) {
      alert("⚠️ Gửi thất bại, kiểm tra mạng hoặc thông số!");
    }
  });

  // Function to send multiple data to Blynk at once
  async function sendMultipleDataToBlynk(data) {
    const parameters = {
      3: data.nd.split("–")[0].split('°')[0],         
      4: data.nd.split("–")[1].split('°')[0],      
      8: data.da.split("–")[0].split('%')[0],       
      9: data.da.split("–")[1].split('%')[0],         
      12: data.as.split("–")[0].split(' lux')[0],    
      13: data.as.split("–")[1].split(' lux')[0],       
    };

    // Loop through each virtual pin and send the corresponding data to Blynk
    for (const [pin, value] of Object.entries(parameters)) {
      try {
        const response = await fetch(`${BLYNK_API_URL}/${BLYNK_AUTH_TOKEN}/update/v${pin}?value=${encodeURIComponent(value)}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (response.ok) {
          console.log(`v${pin} data sent to Blynk: ${value}`);
        } else {
          console.error(`Failed to send data to v${pin}`);
        }
      } catch (err) {
        console.error(`Error sending data to v${pin}:`, err);
      }
    }
  }
 </script>
</body>
</html>
